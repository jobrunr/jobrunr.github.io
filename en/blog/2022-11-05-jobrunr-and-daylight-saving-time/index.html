<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <link rel="dns-prefetch" href="https://www.googletagmanager.com" />
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />

    <link href="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js" rel="preload" as="script" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/prism.min.js" rel="preload" as="script" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/components/prism-java.min.js" rel="preload" as="script" />
    <link href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" rel="preload" as="script" />

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-5770953-9', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    
    
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MX5H2KM');</script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-J3K00HKL9D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-J3K00HKL9D');
</script>
    

    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "gndsmglzod");
    </script>

    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    <title>Oooh, the irony ¬∑ JobRunr</title>

    

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <meta name="description" content="A crime scene investigation on what went wrong with JobRunr when Daylight Saving Time ended.">
    
    
    
    <meta name="author" content="Ronald Dehuysser, ronald@dehuysser.be">

    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:image" content="https://www.jobrunr.io/blog/2020-04-23-jobrunr-gets-jobs-done.webp" />
    <meta name="twitter:image:alt" content="JobRunr - get jobs done" />
    <meta name="twitter:title" content="Oooh, the irony" />
    <meta name="twitter:description" content="A crime scene investigation on what went wrong with JobRunr when Daylight Saving Time ended." />
    <meta name="twitter:creator" content="@rdehuyss" />
    <meta name="twitter:site" content="@jobrunr" />

    <meta property="og:title" content="Oooh, the irony" />
<meta property="og:description" content="A crime scene investigation on what went wrong with JobRunr when Daylight Saving Time ended." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.jobrunr.io/en/blog/2022-11-05-jobrunr-and-daylight-saving-time/" /><meta property="og:image" content="https://www.jobrunr.io/blog/2020-04-23-jobrunr-gets-jobs-done.webp"/><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2022-11-05T09:12:23+02:00" />
<meta property="article:modified_time" content="2022-11-05T09:12:23+02:00" />



    
    
    
    <link rel="stylesheet" href="https://www.jobrunr.io/scss/custom.min.1e934c5202553110f36982d9d20c0e64ed264c1fdb9b6da07fe5eb63c664c8f7.css" integrity="sha256-HpNMUgJVMRDzaYLZ0gwOZO0mTB/bm22gf&#43;XrY8ZkyPc=" media="screen">
    <link rel="stylesheet" href="https://www.jobrunr.io/scss/screen.min.0f64a56815db5c7c6b867fa84982b043c39613ddd05262509e91473bd1766389.css" integrity="sha256-D2SlaBXbXHxrhn&#43;oSYKwQ8OWE93QUmJQnpFHO9F2Y4k=" media="screen">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/themes/prism.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/themes/prism-coy.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" />
</head>
<body class=" post-template ">
    
    <noscript>
      <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MX5H2KM" height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
      
    <div class="site-wrapper">

<header class="site-header" style="height: 64px;"><div class="outer site-nav-main">
    <div class="inner"><nav id="site-nav" class="site-nav">
    <div class="site-nav-left">
        
        <a class="site-nav-logo" href="https://www.jobrunr.io/en/"><img src="https://www.jobrunr.io/images/jobrunr-logo-white.webp" alt="JobRunr" height="21px" width="91px"/></a>
        
        <div class="site-nav-content">
            <ul class="nav" role="menu">
                
                <li class="nav-home" role="menuitem"><a href="/en/">Home</a></li>
                
                <li class="nav-home" role="menuitem"><a href="/en/documentation/">Documentation</a></li>
                
                <li class="nav-home" role="menuitem"><a href="/en/pricing/">JobRunr Pro</a></li>
                
                <li class="nav-home" role="menuitem"><a href="/en/use-case/">Use Cases</a></li>
                
                <li class="nav-home" role="menuitem"><a href="/en/blog/">Blog</a></li>
                
            </ul>
        </div>
    </div>
    <div class="site-nav-right">
        <div id="social-links" class="social-links">
            <style>
                div.social-links {
                    position: relative;
                }
                #lang-selector {
                    display: none;
                    background-color: rgb(144, 162, 170);
                    position: absolute;
                    left: 10px;
                    top: 56px;
                    z-index: 50;
                }
                #lang-selector li {
                    list-style-type: none;
                }
                #lang-selector li a {
                    color: #fff;
                    text-transform: uppercase;
                }
            </style>

            
            <a class="social-link social-link-tw" href="https://github.com/jobrunr/website/tree/master/content/en/blog/2022-11-05-JobRunr-and-daylight-saving-time.md" title="Edit this page on GitHub" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="-3 -3 32 32"><path d="M7.127 22.562l-7.127 1.438 1.438-7.128 5.689 5.69zm1.414-1.414l11.228-11.225-5.69-5.692-11.227 11.227 5.689 5.69zm9.768-21.148l-2.816 2.817 5.691 5.691 2.816-2.819-5.691-5.689z"/></svg></a>
            <a class="social-link social-link-tw" href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjobrunr.io&amp;screen_name=jobrunr&amp;tw_p=followbutton" title="Follow us on Twitter" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"></path></svg></a>
            <a class="social-link social-link-gh" style="color: #fff" href="https://github.com/jobrunr/jobrunr" title="View code on Github" target="_blank" rel="noopener"><svg viewBox="-3 -3 32 32" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg> Source Code</a>
            <script>
                const langLink = document.getElementById("lang-link");
                if(langLink) {
                    const langSelector = document.getElementById("lang-selector");
                    const hideLangSelector = () => {
                        langSelector.style.display = 'none';
                    };
                    
                    const showLangSelector = () => {
                        langSelector.style.display = 'block';
                        setTimeout(hideLangSelector, 3000);
                    };
                    langLink.addEventListener("mouseover", showLangSelector);
                }
            </script>
        </div>
    </div>
</nav>

</div>
</div></header>

<main id="site-main" class="site-main outer">
    <div class="inner">

        <article class="post-full post ">

            <header class="post-full-header">

                
                    
                    <section class="post-full-tags">
                        <a href="/en/tags/blog">blog</a>
                    </section>
                

                <h1 class="post-full-title">Oooh, the irony</h1>

                
                    <p class="post-full-custom-excerpt">A crime scene investigation on what went wrong with JobRunr when Daylight Saving Time ended.</p>
                

                
                
                <div class="post-full-byline">
                    <section class="post-full-byline-content">

                        <ul class="author-list">
    <li class="author-list-item">
        <div class="author-card">
            <div class="author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg></div>
            <div class="author-info">
                <div class="author-info">
                    <h2>Ronald Dehuysser</h2>
                </div>
            </div>
        </div>
        <a href="#" class="author-avatar author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg></a>
    </li>
</ul>

                        <section class="post-full-byline-meta">
                            
                                <h4 class="author-name">Ronald Dehuysser</h4>
                            
                            <div class="byline-meta-content">
                                <time class="byline-meta-date" datetime="2022-911-11">5 November 2022</time>
                                <span class="byline-reading-time"><span class="bull">&bull;</span> 12 min read</span>
                            </div>
                        </section>

                    </section>
                </div>
                
            </header>

            
            
            
            <figure class="post-full-image blog">
            
                <img src="/blog/2022-11-05-jobrunr-dst.png" alt="blog/2022-11-05-jobrunr-dst.png"/>
            </figure>
            

            <section class="post-full-content">
                <div class="post-content">
                    

<div style="text-align: center;margin: -2em 0 2em;">
<small style="font-size: 70%;"><a href='https://www.freepik.com/vectors/cartoon-astronaut'>Cartoon astronaut vector created by catalyststuff - www.freepik.com</a></small>
</div>
<h2 id="what-is-this-blog-post-about">What is this blog post about?</h2>
<p>Beginning of October, I wrote a blog post about how JobRunr handles Jobs and DST - if you want, you can still read that <a href="https://www.jobrunr.io/en/blog/2022-10-05-jobrunr-and-daylight-saving-time/">blog post here</a>.</p>
<blockquote>
<p>TLDR; it goes about how you don&rsquo;t need to worry about your scheduled jobs when using JobRunr.</p>
</blockquote>
<p>In this blog post, I want to go deeper and find out the root cause on why JobRunr stopped processing jobs when DST ended. Or how to save a java 8 <code>Instant</code> via JDBC to your SQL Database. Or how to save a <code>java.sql.Timestamp</code> in UTC format. Or how Intellij code completion saved my ass by chance by proposing a solution no-where to be found on the internet&hellip;</p>
<p>And this blog post is also about me saying sorry üò¢.</p>
<img src="/blog/2022-11-05-irony.gif" />
<h2 id="when-you-write-a-blog-post-how-things-wont-go-wrong-but-do-go-wrong">When you write a blog post how things wont go wrong but do go wrong&hellip;</h2>
<p>On Monday the 31th of October 2022, a Github issue was created: <a href="https://github.com/jobrunr/jobrunr/issues/598">Unrecoverable error on time change due to daylight saving timezone change</a> by <a href="https://github.com/raffig">@raffig</a>. Not possible, I thought&hellip; probably again somebody using MySQL?</p>
<p>Personally, I did not notice the bug myself yet (and this week I found out why: because my containers restart automatically if the health check fails üòè).</p>
<h2 id="first-back-to-the-past">First, back to the past</h2>
<p>The <a href="https://github.com/jobrunr/jobrunr/issues/248">same issue</a> was already reported last year but as I did not suffer any problems thanks to the container magic mentioned above, I did what any developer would do: head over to <a href="https://www.google.com/search?q=mysql+dst">google</a> and open the <a href="https://stackoverflow.com/questions/1646171/mysql-datetime-fields-and-daylight-savings-time-how-do-i-reference-the-extra">first stackoverflow post</a>. What does it mention in the first answer?</p>
<blockquote>
<p>Neither the DATETIME nor the TIMESTAMP field types can accurately store data in a timezone that observes DST.</p>
</blockquote>
<p>There it is, in writing! It even has <strong>97 Upvotes</strong> so it must be correct! But, let&rsquo;s not be too eager and let&rsquo;s also read the second answer:</p>
<blockquote>
<p>MySQL&rsquo;s date types are, frankly, broken and cannot store all times correctly unless your system is set to a constant offset timezone, like UTC or GMT-5. (I&rsquo;m using MySQL 5.0.45)</p>
</blockquote>
<p><strong>54 Upvotes!</strong> That is even more proof!! Alright, problem solved - it must be related to MySQL. On top of that, JobRunr only relies on <a href="https://docs.oracle.com/javase/8/docs/api/java/time/Instant.html">Instants</a> - the new date and time API that was added in Java 8. So, it must be really related to MySQL, no? Yes, I can safely <a href="https://github.com/jobrunr/jobrunr/issues/248#issuecomment-982072478">close the issue</a>.</p>
<img src="/blog/2022-11-05-what-a-mistake.gif" />
<h2 id="so-what-happened">So, what happened?</h2>
<p>As this year more users had the same issue with different databases, it was time to do a crime scene investigation of what happened.</p>
<h3 id="but-a-bit-of-background-first">But, a bit of background first!</h3>
<p>JobRunr is a cloud-native Job Scheduler meaning that if a <code>BackgroundJobServer</code> goes down (due to a container crash, &hellip;), it will be automatically removed from the list of <code>BackgroundJobServers</code>. This also makes sure that jobs that were being processed by the <code>BackgroundJobServer</code> that died, can be picked up by another <code>BackgroundJobServer</code>.</p>
<p>To make all of this work, each <code>BackgroundJobServer</code> updates the <code>lastHeartbeat</code> column with a UTC timestamp every 15 seconds (the <code>pollIntervalInSeconds</code>) in the <code>jobrunr_backgroundjobservers</code> table and then performs a delete of all the <code>BackgroundJobServers</code> that have <code>lastHeartbeat</code> older than <code>Instant.now().minus(timeOutDuration)</code> where <code>timeOutDuration</code> is typically a minute (but depends on your <code>pollIntervalInSeconds</code>).</p>
<h3 id="fast-forward-to-sunday-october-30th-at-259-am">Fast forward to Sunday October 30th at 2:59 am</h3>
<p>So, I setup my machine to reproduce this and put the date to 2:59 on Sunday October 30th while having a JobRunr instance running. And look what happened:</p>
<figure style="width:100%;">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>02:00<span style="color:#f92672">:</span>57<span style="color:#f92672">.</span><span style="color:#a6e22e">024</span> <span style="color:#f92672">[</span>backgroundjob<span style="color:#f92672">-</span>zookeeper<span style="color:#f92672">-</span>pool<span style="color:#f92672">-</span>2<span style="color:#f92672">-</span>thread<span style="color:#f92672">-</span>1<span style="color:#f92672">]</span> INFO  org<span style="color:#f92672">.</span><span style="color:#a6e22e">jobrunr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">server</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ServerZooKeeper</span> <span style="color:#f92672">-</span> Removed 1 <span style="color:#a6e22e">server</span><span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> that timed out
</span></span><span style="display:flex;"><span>02:00<span style="color:#f92672">:</span>57<span style="color:#f92672">.</span><span style="color:#a6e22e">044</span> <span style="color:#f92672">[</span>backgroundjob<span style="color:#f92672">-</span>zookeeper<span style="color:#f92672">-</span>pool<span style="color:#f92672">-</span>2<span style="color:#f92672">-</span>thread<span style="color:#f92672">-</span>1<span style="color:#f92672">]</span> ERROR org<span style="color:#f92672">.</span><span style="color:#a6e22e">jobrunr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">server</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ServerZooKeeper</span> <span style="color:#f92672">-</span> An unrecoverable error occurred<span style="color:#f92672">.</span> Shutting server down<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>org<span style="color:#f92672">.</span><span style="color:#a6e22e">jobrunr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">JobRunrException</span><span style="color:#f92672">:</span> JobRunr encountered a problematic exception<span style="color:#f92672">.</span> Please create a bug <span style="color:#a6e22e">report</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">if</span> possible<span style="color:#f92672">,</span> provide the code to reproduce <span style="color:#66d9ef">this</span> and the stacktrace<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	at org<span style="color:#f92672">.</span><span style="color:#a6e22e">jobrunr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">JobRunrException</span><span style="color:#f92672">.</span><span style="color:#a6e22e">shouldNotHappenException</span><span style="color:#f92672">(</span>JobRunrException<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>33<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	at org<span style="color:#f92672">.</span><span style="color:#a6e22e">jobrunr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">storage</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sql</span><span style="color:#f92672">.</span><span style="color:#a6e22e">common</span><span style="color:#f92672">.</span><span style="color:#a6e22e">BackgroundJobServerTable</span><span style="color:#f92672">.</span><span style="color:#a6e22e">lambda$getLongestRunningBackgroundJobServerId$3</span><span style="color:#f92672">(</span>BackgroundJobServerTable<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>98<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	at java<span style="color:#f92672">.</span><span style="color:#a6e22e">base</span><span style="color:#f92672">/</span>java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Optional</span><span style="color:#f92672">.</span><span style="color:#a6e22e">orElseThrow</span><span style="color:#f92672">(</span>Optional<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>403<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	at org<span style="color:#f92672">.</span><span style="color:#a6e22e">jobrunr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">storage</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sql</span><span style="color:#f92672">.</span><span style="color:#a6e22e">common</span><span style="color:#f92672">.</span><span style="color:#a6e22e">BackgroundJobServerTable</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getLongestRunningBackgroundJobServerId</span><span style="color:#f92672">(</span>BackgroundJobServerTable<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>98<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	at org<span style="color:#f92672">.</span><span style="color:#a6e22e">jobrunr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">storage</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sql</span><span style="color:#f92672">.</span><span style="color:#a6e22e">common</span><span style="color:#f92672">.</span><span style="color:#a6e22e">DefaultSqlStorageProvider</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getLongestRunningBackgroundJobServerId</span><span style="color:#f92672">(</span>DefaultSqlStorageProvider<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>116<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	at org<span style="color:#f92672">.</span><span style="color:#a6e22e">jobrunr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">storage</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ThreadSafeStorageProvider</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getLongestRunningBackgroundJobServerId</span><span style="color:#f92672">(</span>ThreadSafeStorageProvider<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>74<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	at org<span style="color:#f92672">.</span><span style="color:#a6e22e">jobrunr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">server</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ServerZooKeeper</span><span style="color:#f92672">.</span><span style="color:#a6e22e">determineIfCurrentBackgroundJobServerIsMaster</span><span style="color:#f92672">(</span>ServerZooKeeper<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>115<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	at org<span style="color:#f92672">.</span><span style="color:#a6e22e">jobrunr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">server</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ServerZooKeeper</span><span style="color:#f92672">.</span><span style="color:#a6e22e">signalBackgroundJobServerAliveAndDoZooKeeping</span><span style="color:#f92672">(</span>ServerZooKeeper<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>79<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	at org<span style="color:#f92672">.</span><span style="color:#a6e22e">jobrunr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">server</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ServerZooKeeper</span><span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>ServerZooKeeper<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>49<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	at java<span style="color:#f92672">.</span><span style="color:#a6e22e">base</span><span style="color:#f92672">/</span>java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">concurrent</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Executors$RunnableAdapter</span><span style="color:#f92672">.</span><span style="color:#a6e22e">call</span><span style="color:#f92672">(</span>Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>539<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	at java<span style="color:#f92672">.</span><span style="color:#a6e22e">base</span><span style="color:#f92672">/</span>java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">concurrent</span><span style="color:#f92672">.</span><span style="color:#a6e22e">FutureTask</span><span style="color:#f92672">.</span><span style="color:#a6e22e">runAndReset</span><span style="color:#f92672">(</span>FutureTask<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>305<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	at java<span style="color:#f92672">.</span><span style="color:#a6e22e">base</span><span style="color:#f92672">/</span>java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">concurrent</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ScheduledThreadPoolExecutor$ScheduledFutureTask</span><span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>ScheduledThreadPoolExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>305<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	at java<span style="color:#f92672">.</span><span style="color:#a6e22e">base</span><span style="color:#f92672">/</span>java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">concurrent</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ThreadPoolExecutor</span><span style="color:#f92672">.</span><span style="color:#a6e22e">runWorker</span><span style="color:#f92672">(</span>ThreadPoolExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>1136<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	at java<span style="color:#f92672">.</span><span style="color:#a6e22e">base</span><span style="color:#f92672">/</span>java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">concurrent</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ThreadPoolExecutor$Worker</span><span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>ThreadPoolExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>635<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	at java<span style="color:#f92672">.</span><span style="color:#a6e22e">base</span><span style="color:#f92672">/</span>java<span style="color:#f92672">.</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Thread</span><span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>833<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Caused by<span style="color:#f92672">:</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">IllegalStateException</span><span style="color:#f92672">:</span> No servers available<span style="color:#f92672">?!</span>
</span></span></code></pre></div></figure>
<p>Wait, what? why? That&rsquo;s not possible as the code is as follows:</p>
<figure style="width:60%;">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">signalBackgroundJobServerAliveAndDoZooKeeping</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    signalBackgroundJobServerAlive<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    deleteServersThatTimedOut<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    determineIfCurrentBackgroundJobServerIsMaster<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><figcaption>It first signals that the server is alive (so setting the lastHeartbeat to Instant.now()) and then immediately removes the old servers.</figcaption>
</figure>
<p>As I did not understand what was going on, I decided to add logging to the SQL statements and I immediately notice something is off (can you see it too?)&hellip;</p>
<figure style="width:100%;">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>2022<span style="color:#f92672">-</span>10<span style="color:#f92672">-</span>30T00<span style="color:#f92672">:</span>59<span style="color:#f92672">:</span>46<span style="color:#f92672">.</span><span style="color:#a6e22e">363080Z</span> <span style="color:#f92672">[</span>SQL<span style="color:#f92672">]</span> update jobrunr_backgroundjobservers SET lastHeartbeat <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>2022<span style="color:#f92672">-</span>10<span style="color:#f92672">-</span>30 02<span style="color:#f92672">:</span>59<span style="color:#f92672">:</span>46<span style="color:#f92672">.</span><span style="color:#a6e22e">30802</span><span style="color:#f92672">+</span>02<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">,</span> systemFreeMemory <span style="color:#f92672">=</span> 1706557440<span style="color:#f92672">,</span> systemCpuLoad <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">13283909524169757</span><span style="color:#f92672">,</span> processFreeMemory <span style="color:#f92672">=</span> 17146814960<span style="color:#f92672">,</span> processAllocatedMemory <span style="color:#f92672">=</span> 33054224<span style="color:#f92672">,</span> processCpuLoad <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">13283909524169757</span> where id <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>281091d6<span style="color:#f92672">-</span>37df<span style="color:#f92672">-</span>42aa<span style="color:#f92672">-</span>8fc3<span style="color:#f92672">-</span>0bc7dd45e13b<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>2022<span style="color:#f92672">-</span>10<span style="color:#f92672">-</span>30T00<span style="color:#f92672">:</span>59<span style="color:#f92672">:</span>46<span style="color:#f92672">.</span><span style="color:#a6e22e">399345Z</span> <span style="color:#f92672">[</span>SQL<span style="color:#f92672">]</span> delete from jobrunr_backgroundjobservers where lastHeartbeat <span style="color:#f92672">&lt;</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>2022<span style="color:#f92672">-</span>10<span style="color:#f92672">-</span>30 02<span style="color:#f92672">:</span>58<span style="color:#f92672">:</span>46<span style="color:#f92672">.</span><span style="color:#a6e22e">372111</span><span style="color:#f92672">+</span>02<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>2022<span style="color:#f92672">-</span>10<span style="color:#f92672">-</span>30T01<span style="color:#f92672">:</span>00<span style="color:#f92672">:</span>01<span style="color:#f92672">.</span><span style="color:#a6e22e">483854Z</span> <span style="color:#f92672">[</span>SQL<span style="color:#f92672">]</span> update jobrunr_backgroundjobservers SET lastHeartbeat <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>2022<span style="color:#f92672">-</span>10<span style="color:#f92672">-</span>30 02<span style="color:#f92672">:</span>00<span style="color:#f92672">:</span>01<span style="color:#f92672">.</span><span style="color:#a6e22e">425121</span><span style="color:#f92672">+</span>01<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">,</span> systemFreeMemory <span style="color:#f92672">=</span> 1712275456<span style="color:#f92672">,</span> systemCpuLoad <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">12628588975894364</span><span style="color:#f92672">,</span> processFreeMemory <span style="color:#f92672">=</span> 17141209232<span style="color:#f92672">,</span> processAllocatedMemory <span style="color:#f92672">=</span> 38659952<span style="color:#f92672">,</span> processCpuLoad <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">12628588975894364</span> where id <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>281091d6<span style="color:#f92672">-</span>37df<span style="color:#f92672">-</span>42aa<span style="color:#f92672">-</span>8fc3<span style="color:#f92672">-</span>0bc7dd45e13b<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>2022<span style="color:#f92672">-</span>10<span style="color:#f92672">-</span>30T01<span style="color:#f92672">:</span>00<span style="color:#f92672">:</span>16<span style="color:#f92672">.</span><span style="color:#a6e22e">574843Z</span> <span style="color:#f92672">[</span>SQL<span style="color:#f92672">]</span> update jobrunr_backgroundjobservers SET lastHeartbeat <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>2022<span style="color:#f92672">-</span>10<span style="color:#f92672">-</span>30 02<span style="color:#f92672">:</span>00<span style="color:#f92672">:</span>16<span style="color:#f92672">.</span><span style="color:#a6e22e">528987</span><span style="color:#f92672">+</span>01<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">,</span> systemFreeMemory <span style="color:#f92672">=</span> 1686863872<span style="color:#f92672">,</span> systemCpuLoad <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">12121212121212122</span><span style="color:#f92672">,</span> processFreeMemory <span style="color:#f92672">=</span> 17137283208<span style="color:#f92672">,</span> processAllocatedMemory <span style="color:#f92672">=</span> 42585976<span style="color:#f92672">,</span> processCpuLoad <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">12121212121212122</span> where id <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>281091d6<span style="color:#f92672">-</span>37df<span style="color:#f92672">-</span>42aa<span style="color:#f92672">-</span>8fc3<span style="color:#f92672">-</span>0bc7dd45e13b<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>2022<span style="color:#f92672">-</span>10<span style="color:#f92672">-</span>30T01<span style="color:#f92672">:</span>00<span style="color:#f92672">:</span>31<span style="color:#f92672">.</span><span style="color:#a6e22e">669645Z</span> <span style="color:#f92672">[</span>SQL<span style="color:#f92672">]</span> update jobrunr_backgroundjobservers SET lastHeartbeat <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>2022<span style="color:#f92672">-</span>10<span style="color:#f92672">-</span>30 02<span style="color:#f92672">:</span>00<span style="color:#f92672">:</span>31<span style="color:#f92672">.</span><span style="color:#a6e22e">614193</span><span style="color:#f92672">+</span>01<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">,</span> systemFreeMemory <span style="color:#f92672">=</span> 1666220032<span style="color:#f92672">,</span> systemCpuLoad <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">11909921064850643</span><span style="color:#f92672">,</span> processFreeMemory <span style="color:#f92672">=</span> 17155519160<span style="color:#f92672">,</span> processAllocatedMemory <span style="color:#f92672">=</span> 24350024<span style="color:#f92672">,</span> processCpuLoad <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">11909921064850643</span> where id <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>281091d6<span style="color:#f92672">-</span>37df<span style="color:#f92672">-</span>42aa<span style="color:#f92672">-</span>8fc3<span style="color:#f92672">-</span>0bc7dd45e13b<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>2022<span style="color:#f92672">-</span>10<span style="color:#f92672">-</span>30T01<span style="color:#f92672">:</span>00<span style="color:#f92672">:</span>46<span style="color:#f92672">.</span><span style="color:#a6e22e">756569Z</span> <span style="color:#f92672">[</span>SQL<span style="color:#f92672">]</span> update jobrunr_backgroundjobservers SET lastHeartbeat <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>2022<span style="color:#f92672">-</span>10<span style="color:#f92672">-</span>30 02<span style="color:#f92672">:</span>00<span style="color:#f92672">:</span>46<span style="color:#f92672">.</span><span style="color:#a6e22e">711982</span><span style="color:#f92672">+</span>01<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">,</span> systemFreeMemory <span style="color:#f92672">=</span> 1688797184<span style="color:#f92672">,</span> systemCpuLoad <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">1224362473680106</span><span style="color:#f92672">,</span> processFreeMemory <span style="color:#f92672">=</span> 17150370936<span style="color:#f92672">,</span> processAllocatedMemory <span style="color:#f92672">=</span> 29498248<span style="color:#f92672">,</span> processCpuLoad <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">1224362473680106</span> where id <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>281091d6<span style="color:#f92672">-</span>37df<span style="color:#f92672">-</span>42aa<span style="color:#f92672">-</span>8fc3<span style="color:#f92672">-</span>0bc7dd45e13b<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>2022<span style="color:#f92672">-</span>10<span style="color:#f92672">-</span>30T01<span style="color:#f92672">:</span>00<span style="color:#f92672">:</span>46<span style="color:#f92672">.</span><span style="color:#a6e22e">794078Z</span> <span style="color:#f92672">[</span>SQL<span style="color:#f92672">}</span> delete from jobrunr_backgroundjobservers where lastHeartbeat <span style="color:#f92672">&lt;</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>2022<span style="color:#f92672">-</span>10<span style="color:#f92672">-</span>30 02<span style="color:#f92672">:</span>59<span style="color:#f92672">:</span>46<span style="color:#f92672">.</span><span style="color:#a6e22e">763976</span><span style="color:#f92672">+</span>02<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>02:00<span style="color:#f92672">:</span>46<span style="color:#f92672">.</span><span style="color:#a6e22e">797</span> <span style="color:#f92672">[</span>backgroundjob<span style="color:#f92672">-</span>zookeeper<span style="color:#f92672">-</span>pool<span style="color:#f92672">-</span>2<span style="color:#f92672">-</span>thread<span style="color:#f92672">-</span>1<span style="color:#f92672">]</span> INFO  org<span style="color:#f92672">.</span><span style="color:#a6e22e">jobrunr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">server</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ServerZooKeeper</span> <span style="color:#f92672">-</span> Removed 1 <span style="color:#a6e22e">server</span><span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> that timed out
</span></span><span style="display:flex;"><span>02:00<span style="color:#f92672">:</span>46<span style="color:#f92672">.</span><span style="color:#a6e22e">818</span> <span style="color:#f92672">[</span>backgroundjob<span style="color:#f92672">-</span>zookeeper<span style="color:#f92672">-</span>pool<span style="color:#f92672">-</span>2<span style="color:#f92672">-</span>thread<span style="color:#f92672">-</span>1<span style="color:#f92672">]</span> ERROR org<span style="color:#f92672">.</span><span style="color:#a6e22e">jobrunr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">server</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ServerZooKeeper</span> <span style="color:#f92672">-</span> An unrecoverable error occurred<span style="color:#f92672">.</span> Shutting server down<span style="color:#f92672">...</span>
</span></span></code></pre></div><figcaption>Why the ü§¨ are these dates in the SQL statements not in UTC?!?!</figcaption>
</figure>
<p>Back to the code: what happens when a <a href="https://docs.oracle.com/javase/8/docs/api/java/time/Instant.html">Java 8 Instant</a> is transformed to an SQL statement?</p>
<figure style="width:60%;">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> preparedStatement<span style="color:#f92672">.</span><span style="color:#a6e22e">setTimestamp</span><span style="color:#f92672">(</span>i<span style="color:#f92672">,</span> Timestamp<span style="color:#f92672">.</span><span style="color:#a6e22e">from</span><span style="color:#f92672">(</span>instant<span style="color:#f92672">));</span>
</span></span></code></pre></div><figcaption>That looks correct to me, no?</figcaption>
</figure>
<p>That looks correct to me, no? Hmm, let&rsquo;s Google and Stackoverflow again!</p>
<figure>
  <img src="/blog/2022-11-05-no-stackoverflow-for-you.png">
  <figcaption>This is going to be fun...</figcaption>
</figure>
<p>So, after resetting my pc&rsquo;s date and time correct again, I find the following <a href="https://stackoverflow.com/a/54564844/1005124">stackoverflow.com post</a> (yes, again the first link from google) with the following info:</p>
<blockquote>
<p>java.sql.Timestamp is a terrible class, along with its sibling classes such as java.util.Date and Calendar/GregorianCalendar. Among its many design problems is is messy handling of time zones. Instead, use only the modern java.time classes.</p>
</blockquote>
<p>Just for fun, I open the <code>java.sql.Timestamp</code> class:</p>
<figure>
  <img src="/blog/2022-11-05-oooh-noooo.png">
  <figcaption>java.sql.Timestamp extends java.util.Data? This is really going to be fun...</figcaption>
</figure>
<p>Further down in the <a href="https://stackoverflow.com/a/54564844/1005124">stackoverflow.com post</a>, I read the following:</p>
<blockquote>
<p>You may exchange java.time objects directly with your database. Use a JDBC driver compliant with JDBC 4.2 or later. No need for strings, no need for java.sql.* classes.</p>
</blockquote>
<h2 id="lets-fix-this">Let&rsquo;s fix this!</h2>
<h3 id="attempt-1---the-easy-fix">Attempt 1 - the easy fix!</h3>
<p>Alright, this is going to be an easy fix! I just need to change the code snippet from above to <code>preparedStatement.setObject(i, instant);</code>, run the tests and call it a day!</p>
<figure>
  <img style="width:60%; margin: 0 auto;" src="/blog/2022-11-05-oooh-noooo-tests.png">
  <figcaption>Perhaps the fix is not going to be so easy...</figcaption>
</figure>
<p>Luckily, Postgres helps me:</p>
<figure style="width:100%;">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>org<span style="color:#f92672">.</span><span style="color:#a6e22e">postgresql</span><span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">PSQLException</span><span style="color:#f92672">:</span> Can<span style="color:#960050;background-color:#1e0010">&#39;</span>t infer the SQL type to use <span style="color:#66d9ef">for</span> an instance of java<span style="color:#f92672">.</span><span style="color:#a6e22e">time</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Instant</span><span style="color:#f92672">.</span> Use <span style="color:#a6e22e">setObject</span><span style="color:#f92672">()</span> with an explicit Types value to specify the type to use<span style="color:#f92672">.</span>
</span></span></code></pre></div></figure>
<p>Allright, it is still going to be an easy fix. Let&rsquo;s change the code snippet to <code>preparedStatement.setObject(i, instant, Types.TIMESTAMP);</code>. Now these tests will be green! (Please scroll up until you see failing tests image again.)</p>
<p>Hhmm, this time Postgres tells me:</p>
<figure style="width:100%;">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>org<span style="color:#f92672">.</span><span style="color:#a6e22e">postgresql</span><span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">PSQLException</span><span style="color:#f92672">:</span> Bad value <span style="color:#66d9ef">for</span> type timestamp<span style="color:#f92672">/</span>date<span style="color:#f92672">/</span>time<span style="color:#f92672">:</span> 2022<span style="color:#f92672">-</span>11<span style="color:#f92672">-</span>05T17<span style="color:#f92672">:</span>05<span style="color:#f92672">:</span>52<span style="color:#f92672">.</span><span style="color:#a6e22e">581727Z</span>
</span></span></code></pre></div>  <figcaption>hmmm, this does not make sense...</figcaption>
</figure>
<p>Let&rsquo;s try with <code>preparedStatement.setObject(i, instant, Types.TIMESTAMP_WITH_TIMEZONE);</code>. (Please scroll up again until you see failing tests image.)</p>
<figure style="width:100%;">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>org<span style="color:#f92672">.</span><span style="color:#a6e22e">postgresql</span><span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">PSQLException</span><span style="color:#f92672">:</span> Cannot cast an instance of java<span style="color:#f92672">.</span><span style="color:#a6e22e">time</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Instant</span> to type Types<span style="color:#f92672">.</span><span style="color:#a6e22e">TIMESTAMP_WITH_TIMEZONE</span>
</span></span></code></pre></div>  <figcaption>hmmm, this still does not make sense...</figcaption>
</figure>
<p>The <a href="https://stackoverflow.com/a/54564844/1005124">stackoverflow.com post</a> also has a nice picture explaining everything, let&rsquo;s review it again:</p>
<figure>
  <img src="/blog/2022-11-05-jdbc-types.png">
  <figcaption>java.sql.Timestamp extends java.util.Data? This is really going to be fun...</figcaption>
</figure>
<p>I read all the <a href="https://stackoverflow.com/a/22470650/1005124">different</a> <a href="https://stackoverflow.com/a/50668272/1005124">stackoverflow</a> posts but none if works. They say that either the above should work (ü§•) by passing <code>java.time.*</code> Objects or using the <code>Timestamp.from(instant)</code>.</p>
<figure>
  <img src="/blog/2022-11-05-stackoverflow-has-no-answer.webp">
  <figcaption>When Stackoverflow does not provide an answer...</figcaption>
</figure>
<p>Finally, on the third google page with only Stackoverflow results, I read the <a href="https://stackoverflow.com/questions/50986138/converting-java-sql-timestamp-to-instant-time#comment119913322_50987372">following comment</a>:</p>
<blockquote>
<p>If your database datatype had been timestamp with timezone, you could have passed Instant.class to rs.getObject and have got an Instant immediately and would not have hat to convert. - <strong>This is wrong.</strong> The only supported java.time types are <strong>LocalDate, LocalTime, LocalDateTime, OffsetTime, and OffsetDateTime</strong>. Also, some DBs do not support LocalTime and OffsetTime.</p>
</blockquote>
<p>And it links to the following <a href="https://stackoverflow.com/questions/19080655/how-to-convert-epoch-to-mysql-timestamp-in-java/67752047#67752047">Stackoverflow post</a> which gives a clear overview how to map stuff:</p>
<table>
<thead>
<tr>
<th>ANSI SQL</th>
<th>Java SE 8</th>
</tr>
</thead>
<tbody>
<tr>
<td>DATE</td>
<td>LocalDate</td>
</tr>
<tr>
<td>TIME</td>
<td>LocalTime</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>LocalDateTime</td>
</tr>
<tr>
<td>TIME WITH TIMEZONE</td>
<td>OffsetTime</td>
</tr>
<tr>
<td>TIMESTAMP WITH TIMEZONE</td>
<td>OffsetDateTime</td>
</tr>
</tbody>
</table>
<p>There is no standard way to save a <code>java.time.Instant</code> with a JDBC 4.2 compatible Driver (let&rsquo;s talk about missed opportunities). But as <a href="https://stackoverflow.com/users/10819573/arvind-kumar-avinash">Arvind Kumar</a> puts it nicely, an Instant represents an instantaneous point on the timeline and is independent of a timezone i.e. it has a timezone offset of +00:00 hours. The recommended way to save a <code>java.time.Instant</code> is to use <code>java.time.OffsetDateTime</code>. Finally, a possible solution!</p>
<h3 id="attempt-2---batman-vs-robin">Attempt 2 - Batman vs Robin</h3>
<p>Originally, when I created JobRunr I used <code>TIMESTAMP(6)</code> for the <code>lastHeartbeat</code> - my idea back then is that I wouldn&rsquo;t need a TimeZone as all the jobs were using UTC Timestamps. Now, I needed to revisit that choice and create an SQL script that migrates all these columns of type <code>TIMESTAMP(6)</code> to <code>TIMESTAMP(6) WITH TIME ZONE</code>. Just to make sure that this approach would work, I changed the original script to this <code>TIMESTAMP(6) WITH TIME ZONE</code>, saved the <code>java.time.Instant</code> as an <code>java.time.OffsetDateTime</code> and altered my computers date back to Sunday October 30th at 2:59 am using Postgres as my choice of weapon. Yes, it works! No <code>BackgroundJobServer</code> is removed!</p>
<p>But - my gut feeling (Batman) did not like this approach my brain (Robin) proposed.</p>
<figure>
  <img src="/blog/2022-11-05-batman.jpeg">
  <figcaption>My gut feeling slapping my brain...</figcaption>
</figure>
<p>As the <code>TIMESTAMP(6)</code> is part of the DB index changing it to a <code>TIMESTAMP(6) WITH TIME ZONE</code>, all the indexes would also need to be recreated and a customer already got into contact with me that these automated migrations fail for them as the readiness probe takes too long to return true.
On top of that, the change has also quite some impact in other places (like for Scheduled Jobs, &hellip; ).
Time to go back to the drawing board&hellip;</p>
<h3 id="attempt-3---localdatetime-to-the-rescue">Attempt 3 - LocalDateTime to the rescue!</h3>
<p>I still don&rsquo;t agree that we need to save a TimeZone in the <code>TIMESTAMP(6) WITH TIME ZONE</code> to save a simple database Timestamp. What if &hellip; we transform the <code>Instant</code> to a <code>LocalDateTime</code> in UTC Timezone? Wouldn&rsquo;t that work?</p>
<p>The code from above then become  <code>preparedStatement.setObject(i, LocalDateTime.ofInstant(instant, ZoneOffset.UTC));</code></p>
<p>Jeeej! Only one failing test per database! And, if I go back in time to Sunday October 30th at 2:59 and test the original bug again all is well! The failing test is easily solved (I should then also fetch the <code>java.sql.Timestamp</code> as a <code>java.time.LocalDateTime</code> and transform it back to an <code>java.time.Instant</code>) and I start testing it for each database. There is light at the end of the tunnel!</p>
<figure>
  <img src="/blog/2022-11-05-db2.jpeg">
  <figcaption>Apparently, DB2 does not support JDBC 4.2</figcaption>
</figure>
<p>JobRunr also supports DB2 (it&rsquo;s not used a lot but it is used) and apparently the DB2 JDBC driver does <a href="https://dba.stackexchange.com/questions/252631/support-for-jdbc-4-2">not support</a> JDBC 4.2 - well, the standard was only made in 2014 (together with Java 8) and one cannot expect for all the drivers to be compliant after <span id="days-since-java8">3150</span> days, no?</p>
<p>Well, bad luck for those DB2 people, no? Who uses DB2 anyways?</p>
<h3 id="a-solution-no-where-to-be-found-on-the-internet">A solution no-where to be found on the internet</h3>
<p>Then, by sheer luck, I suddenly saw the following:</p>
<figure>
  <img src="/blog/2022-11-05-intellij-to-the-rescue.png">
  <figcaption>Wait - what is that Calendar I can pass as an extra option?</figcaption>
</figure>
<p>The Javadoc of the <code>java.sql.PreparedStatement</code> says the following:</p>
<blockquote>
<p>Sets the designated parameter to the given java.sql.Timestamp value, using the given Calendar object. The driver uses the Calendar object to construct an SQL TIMESTAMP value, which the driver then sends to the database. With a Calendar object, the driver can calculate the timestamp taking into account a custom timezone. If no Calendar object is specified, the driver uses the default timezone, which is that of the virtual machine running the application.</p>
</blockquote>
<p><strong>This sentence is the actual root cause of the problem - the JDBC driver uses the default timezone of the virtual machine.</strong></p>
<p>So, I changed the code snippet from above again to: <code>preparedStatement.setTimestamp(i, Timestamp.from((Instant) o), Calendar.getInstance(getTimeZone(ZoneOffset.UTC)));</code></p>
<p>And hoooraay!! This <a href="https://github.com/jobrunr/jobrunr/pull/601">solution works</a> for all databases (I have tested it for each and every supported JobRunr database by putting my PC&rsquo;s clock to Sunday October 30th at 2:59 am)!</p>
<h6 id="but-youre-still-using-javasqltimestamp">But, you&rsquo;re still using java.sql.Timestamp?</h6>
<p>To be honest, I don&rsquo;t know if this solution is the best solution as I still use the legacy <code>java.sql.Timestamp</code> and none of the <code>java.time.*</code> classes. But, with the current information that I have at hand, I do think it is the best possible solution. Feel free to <a href="https://github.com/jobrunr/jobrunr/pull/601">reach out</a> if you have other idea&rsquo;s on this topic.</p>
<h6 id="when-will-it-be-released">When will it be released?</h6>
<p>As writing this blog post made me realize it will impact all the Scheduled Jobs, this will be part of JobRunr 6 which will be released somewhere at the end of the year.</p>
<h2 id="conclusion">Conclusion</h2>
<p>If you are using JobRunr, you do not need to be afraid <strong>anymore</strong> of DST - all your scheduled jobs will run! All you need to know is that some scheduled jobs may be impacted because of the change during the time change of DST and will run at most one hour earlier or later.</p>
<p>So, just relax and enjoy that hour of extra sleep üò¥ <strong>(at least next time)</strong>.</p>
<blockquote>
<p>I sincerely want to apologize to all users who had troubles because of this. And to everybody who will have troubles when upgrading as it will also impact your Scheduled Jobs. And to MySQL.</p>
</blockquote>
<script type="text/javascript">
const date1 = new Date('3/18/2014');
const date2 = new Date();
const difference = date2.getTime() - date1.getTime();
const days = Math.ceil(difference / (1000 * 3600 * 24));
document.getElementById("days-since-java8").innerHTML = days + "";
</script>
<h6 id="ps-for-jetbrain-developers">Ps: for JetBrain developers</h6>
<p>It would be fun to still have logging in the Run terminal if you put your PC&rsquo;s date &amp; time in the past. Now, each time I wanted to test a possible solution, I had to restart Intellij as it apparently uses the logging DateTime to filter out logs? Or perhaps I miss a setting?</p>

                </div>
            </section>

        </article>

    </div>
</main>


        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright" style="align-self: start;">
                  &copy; <a href="https://www.jobrunr.io">JobRunr</a>
                </section>
                <section class="love" style="align-self: start; opacity: 0.7;">
                  Made with <strong style="color: red; font-size: large;">&hearts;</strong> in Belgium
                </section>
                <nav class="site-footer-nav">
                  <div>
                    <div><a href="/en/about/" rel="noopener" style="opacity: 0.5;">JobRunr by Rosoco BV (BE 0807596165)</a></div>
                    <div><a href="/en/licensing/info/" rel="noopener" style="opacity: 0.5;">Terms of use</a></div>
                    <div><a href="/en/privacy/" rel="noopener" style="opacity: 0.5;">Privacy</a></div>
                  </div>
                </nav>
            </div>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/components/prism-java.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
<script>
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#000"
    },
    "button": {
      "background": "transparent",
      "border": "#fff",
      "text": "#fff"
    }
  },
  "content": {
    "link": "Learn more about cookies"
  }
});

var links = document.querySelectorAll('a');
for (var i = 0; i < links.length; i++) {
  if (links[i].hostname != window.location.hostname) {
    links[i].target = '_blank';
    links[i].rel = 'noopener';
  }
}
</script>

</body>
</html>