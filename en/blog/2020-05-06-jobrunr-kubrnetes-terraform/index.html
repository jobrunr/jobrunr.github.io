<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <link rel="dns-prefetch" href="https://www.googletagmanager.com" />
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />

    <link href="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js" rel="preload" as="script" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/prism.min.js" rel="preload" as="script" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/components/prism-java.min.js" rel="preload" as="script" />
    <link href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" rel="preload" as="script" />

    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    <title>JobRunr ♥ Kubernetes ♥ Terraform · JobRunr</title>

    

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <meta name="description" content="Learn how to scale JobRunr to have a whopping 869% speed increase">
    
    
    
    <meta name="author" content="Ronald Dehuysser, ronald@dehuysser.be">

    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:image" content="https://www.jobrunr.io/blog/2020-04-23-jobrunr-gets-jobs-done.webp" />
    <meta name="twitter:image:alt" content="JobRunr - get jobs done" />
    <meta name="twitter:title" content="JobRunr ♥ Kubernetes ♥ Terraform" />
    <meta name="twitter:description" content="Learn how to scale JobRunr to have a whopping 869% speed increase" />
    <meta name="twitter:creator" content="@rdehuyss" />
    <meta name="twitter:site" content="@jobrunr" />

    <meta property="og:title" content="JobRunr ♥ Kubernetes ♥ Terraform" />
<meta property="og:description" content="Learn how to scale JobRunr to have a whopping 869% speed increase" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.jobrunr.io/en/blog/2020-05-06-jobrunr-kubrnetes-terraform/" /><meta property="og:image" content="https://www.jobrunr.io/blog/2020-04-23-jobrunr-gets-jobs-done.webp" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2020-05-06T11:12:23+02:00" />
<meta property="article:modified_time" content="2020-05-06T11:12:23+02:00" />


    
    
    
    <link rel="stylesheet" href="https://www.jobrunr.io/scss/custom.min.bc530210025672c5275e73d223263a1b309dd66c3a929bc89143e11ae911ac39.css" integrity="sha256-vFMCEAJWcsUnXnPSIyY6GzCd1mw6kpvIkUPhGukRrDk=" media="screen">
    <link rel="stylesheet" href="https://www.jobrunr.io/scss/screen.min.5cb3f5840ac2d788ddd0b4fdf55fe2bef4413a74dc36d13e4ecd8405c0c8bd7f.css" integrity="sha256-XLP1hArC14jd0LT99V/ivvRBOnTcNtE&#43;Ts2EBcDIvX8=" media="screen">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/themes/prism.min.css" as="style" onload="this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/themes/prism.min.css"></noscript>
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/themes/prism-coy.min.css" as="style" onload="this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/themes/prism-coy.min.css"></noscript>
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" as="style" onload="this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css"></noscript>
</head>
<body class=" post-template ">
    
    <noscript>
      <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MX5H2KM" height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
      
    <div class="site-wrapper">

<header class="site-header" style="height: 64px;"><div class="outer site-nav-main">
    <div class="inner">
<nav id="site-nav" class="site-nav">
    <div class="site-nav-left">
        
        <a class="site-nav-logo" href="https://www.jobrunr.io//en/"><img src="https://www.jobrunr.io/images/jobrunr-logo-white.webp" alt="JobRunr" height="21px" width="91px"/></a>
        
        <div class="site-nav-content">
            <ul class="nav" role="menu">
                
                <li class="nav-home" role="menuitem"><a href="/en/">Home</a></li>
                
                <li class="nav-home" role="menuitem"><a href="/en/pricing/">JobRunr Pro</a></li>
                
                <li class="nav-home" role="menuitem"><a href="/en/documentation/">Documentation</a></li>
                
                <li class="nav-home" role="menuitem"><a href="/en/guides/">guides</a></li>
                
                <li class="nav-home" role="menuitem"><a href="/en/use-case/">Use Cases</a></li>
                
                <li class="nav-home" role="menuitem"><a href="/en/blog/">Blog</a></li>
                
            </ul>
        </div>
    </div>
    <div class="site-nav-right">
        <div id="social-links" class="social-links">
            <style>
                div.social-links {
                    position: relative;
                }
                #lang-selector {
                    display: none;
                    background-color: rgb(144, 162, 170);
                    position: absolute;
                    left: 10px;
                    top: 56px;
                    z-index: 50;
                }
                #lang-selector li {
                    list-style-type: none;
                }
                #lang-selector li a {
                    color: #fff;
                    text-transform: uppercase;
                }
            </style>

            
            <a class="social-link social-link-tw" href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjobrunr.io&amp;screen_name=jobrunr&amp;tw_p=followbutton" title="Follow us on Twitter" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"></path></svg></a>
            <a class="social-link social-link-gh" style="color: #fff" href="https://github.com/jobrunr/jobrunr" title="View code on Github" target="_blank" rel="noopener"><svg viewBox="-3 -3 32 32" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg> Source Code</a>
            <script>
                const langLink = document.getElementById("lang-link");
                if(langLink) {
                    const langSelector = document.getElementById("lang-selector");
                    const hideLangSelector = () => {
                        langSelector.style.display = 'none';
                    };
                    
                    const showLangSelector = () => {
                        langSelector.style.display = 'block';
                        setTimeout(hideLangSelector, 3000);
                    };
                    langLink.addEventListener("mouseover", showLangSelector);
                }
            </script>
        </div>
    </div>
</nav>

</div>
</div></header>

<main id="site-main" class="site-main outer">
    <div class="inner">

        <article class="post-full post ">

            <header class="post-full-header">

                
                    
                    <section class="post-full-tags">
                        <a href="/en/tags/blog">blog</a>
                    </section>
                

                <h1 class="post-full-title">JobRunr ♥ Kubernetes ♥ Terraform</h1>

                
                    <p class="post-full-custom-excerpt">Learn how to scale JobRunr to have a whopping 869% speed increase</p>
                

                
                
                <div class="post-full-byline">
                    <section class="post-full-byline-content">

                        <ul class="author-list">
    <li class="author-list-item">
        <div class="author-card">
            <div class="author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg></div>
            <div class="author-info">
                <div class="author-info">
                    <h2>Ronald Dehuysser</h2>
                </div>
            </div>
        </div>
        <a href="#" class="author-avatar author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg></a>
    </li>
</ul>

                        <section class="post-full-byline-meta" style="width: 100%">
                            
                                <h4 class="author-name">Ronald Dehuysser</h4>
                            
                            <div class="byline-meta-content">
                                
                                    <time class="byline-meta-date" datetime="2020-115-05">6 May 2020</time>
                                    <span class="bull">&bull;</span>
                                 
                                <span class="byline-reading-time">14 min read</span>

                                 
                            </div>
                        </section>
                    </section>
                </div>
                
            </header>

            
            
            
            <figure class="post-full-image blog">
            
                <img src="/blog/balloons.webp" alt="/blog/balloons.webp"/>
            </figure>
            

            <section class="post-full-content">
                <div class="post-content">
                    <p>In this new tutorial, we will build further upon on our <a href="https://www.jobrunr.io/en/blog/2020-04-23-jobrunr-long-running-jobs/">first tutorial</a> - Easily process long-running jobs with JobRunr and deploy the JobRunr application to a Kubernetes cluster on the Google Cloud Platform (GCP) using Terraform. We then scale it up to 10 instances to have a <strong>whopping 869% speed increase</strong> compared to only one instance!</p>
<blockquote>
<p>This tutorial is a beginners guide on the topic cloud infrastructure management - feel free to skip to the parts that interest you.</p>
</blockquote>
<p>Kubernetes - also known as k8s - is the hot new devops tool for deploying high-available applications. Today, there are a lot of providers all supporting kubernetes including the well known Google Kubernetes Engine (GKE), Azure Kubernetes Service (AKS) and Amazon Elastic Kubernetes Service (EKS).</p>
<p>Although the world is currently in difficult times because of COVID-19, Acme Corp (see the first tutorial) hired so many people that there are now about 10.000 employees working for them. Acme Corp&rsquo;s CEO insists that all employees get their weekly salary slip before Sunday 11pm but this has now become impossible - the amount of time it takes for generating that many salary slips is just too long.</p>
<p>Luckily JobRunr is here to help as it is a <strong>distributed background job processing framework</strong>. In this tutorial we will:</p>
<ul>
<li>create a Docker image from our SalarySlipMicroservice JobRunr application using Jib by Google</li>
<li>upload the Docker image to a private Docker registry at Google</li>
<li>use Terraform to define our infrastructure as code which includes a Google Cloud Sql instance.</li>
<li>deploy a Kubernetes cluster using Terraform to Google Cloud</li>
<li>deploy one instance of the SalarySlipMicroservice JobRunr Docker image to the Kubernetes cluster</li>
<li>start generating all the employee slips</li>
<li>scale to 10 instances of the SalarySlipMicroservice JobRunr application and all of this without any change to our production java code!</li>
</ul>
<blockquote>
<p>TLDR; you can find the complete project on our Github repository: <a href="https://github.com/jobrunr/example-salary-slip/tree/kubernetes">https://github.com/jobrunr/example-salary-slip/tree/kubernetes</a></p>
</blockquote>
<h3 id="postgres-as-database">Postgres as database</h3>
<p>In the first version of our application, we used an embedded H2 Database. As we now go for a deployment on Google Cloud Platform (GCP), we will use a Cloud Sql Postgres instance. To do so, we need to change our DataSource in the SalarySlipMicroService as follows:</p>
<figure style="width: 100%; max-width: 100%">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> DataSource <span style="color:#a6e22e">dataSource</span>() {
</span></span><span style="display:flex;"><span>    HikariConfig config <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HikariConfig();
</span></span><span style="display:flex;"><span>    config.<span style="color:#a6e22e">setJdbcUrl</span>(String.<span style="color:#a6e22e">format</span>(<span style="color:#e6db74">&#34;jdbc:postgresql:///%s&#34;</span>, System.<span style="color:#a6e22e">getenv</span>(<span style="color:#e6db74">&#34;DB_NAME&#34;</span>)));
</span></span><span style="display:flex;"><span>    config.<span style="color:#a6e22e">setUsername</span>(System.<span style="color:#a6e22e">getenv</span>(<span style="color:#e6db74">&#34;DB_USER&#34;</span>));
</span></span><span style="display:flex;"><span>    config.<span style="color:#a6e22e">setPassword</span>(System.<span style="color:#a6e22e">getenv</span>(<span style="color:#e6db74">&#34;DB_PASS&#34;</span>));
</span></span><span style="display:flex;"><span>    config.<span style="color:#a6e22e">addDataSourceProperty</span>(<span style="color:#e6db74">&#34;socketFactory&#34;</span>, <span style="color:#e6db74">&#34;com.google.cloud.sql.postgres.SocketFactory&#34;</span>);
</span></span><span style="display:flex;"><span>    config.<span style="color:#a6e22e">addDataSourceProperty</span>(<span style="color:#e6db74">&#34;cloudSqlInstance&#34;</span>, System.<span style="color:#a6e22e">getenv</span>(<span style="color:#e6db74">&#34;CLOUD_SQL_INSTANCE&#34;</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> HikariDataSource(config);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><figcaption>The DataSource now uses environment variables to connect to the Postgres Cloud Sql instance.</figcaption>
</figure>
<h3 id="dockerize-it">Dockerize it!</h3>
<p>Since Kubernetes runs Pods - which are in fact one or more Docker Containers - we first need to create a Docker Image from our application. <a href="https://github.com/GoogleContainerTools/jib">Jib</a> is a tool from Google to easily create Docker images from your Java application using only Maven or Gradle.</p>
<p>In our build.gradle file we add the following plugin:</p>
<figure style="width: 100%; max-width: 100%">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>plugins {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    id <span style="color:#960050;background-color:#1e0010">&#39;</span>com.<span style="color:#a6e22e">google</span>.<span style="color:#a6e22e">cloud</span>.<span style="color:#a6e22e">tools</span>.<span style="color:#a6e22e">jib</span><span style="color:#960050;background-color:#1e0010">&#39;</span> version <span style="color:#960050;background-color:#1e0010">&#39;</span>2.<span style="color:#a6e22e">2</span>.<span style="color:#a6e22e">0</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jib {
</span></span><span style="display:flex;"><span>    from {
</span></span><span style="display:flex;"><span>        image <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gcr.io/distroless/java:11&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    to {
</span></span><span style="display:flex;"><span>        image <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gcr.io/jobrunr-tutorial-kubernetes/jobrunr-${project.name}:1.0&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    container {
</span></span><span style="display:flex;"><span>        jvmFlags <span style="color:#f92672">=</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;-Duser.timezone=Europe/Brussels&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        ports <span style="color:#f92672">=</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;8000&#34;</span>, <span style="color:#e6db74">&#34;8080&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><figcaption>We configure the <i>jib</i> plugin and tell it to build further upon the distroless Java 11 base image. We tag it with `gcr.io/jobrunr-tutorial-kubernetes/jobrunr-${project.name}:1.0` so that it will be available later in GCP, specify the timezone and tell it to expose some ports.</figcaption>
</figure>
<p>If we now run the gradle command: <code>./gradlew jibDockerBuild</code> it will create a new Docker image for us, ready to run on Docker!</p>
<h3 id="install-necessary-tools">Install necessary tools</h3>
<p>We now need to install all the necessary tools and create a Google Cloud account:</p>
<ul>
<li><a href="https://cloud.google.com/sdk/docs">Google Cloud SDK</a>: Google Cloud SDK is a set of tools that you can use to manage resources and applications hosted on Google Cloud Platform.</li>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">Kubectl</a>: Kubectl is a command line tool for controlling Kubernetes clusters.</li>
<li><a href="https://learn.hashicorp.com/terraform/getting-started/install.html">Terraform</a>: Terraform is an open-source infrastructure as code software tool created by HashiCorp. It enables users to define and provision a datacenter infrastructure using a high-level configuration language known as Hashicorp Configuration Language.</li>
</ul>
<p>The installation for these tools is well explained and differs for each OS. Follow the installation guide for them and come back to the tutorial once you have done so.</p>
<p>We also need an account for Google Cloud. Using your browser navigate to <a href="https://console.cloud.google.com/">https://console.cloud.google.com/</a>  - when you first login to the Google Cloud Platform you get 300 € of free credit, more than enough for us. You can activate it on the top right.</p>
<figure style="width: 100%; max-width: 100%">
<img src="/blog/2020-05-06-kubernetes-gcp-01.webp" alt="" class="kg-image" />
<figcaption>The Google console dashboard with the free trial at the top</figcaption>
</figure>
<h3 id="create-the-gcp-project">Create the GCP Project</h3>
<p>In this tutorial, we will use the terminal as much as possible - so fire up a terminal and login to gcloud using the command: <code>~$ gcloud auth login</code> - this will allow you to login only once for all future <code>gcloud</code> commands.</p>
<p>To deploy a Kubernetes cluster to GCP, we first need to create a new GCP project, add a billing account to it, enable the container API&rsquo;s and upload our docker image:</p>
<figure style="width: 100%; max-width: 100%">
<pre tabindex="0"><code>~$ gcloud projects create jobrunr-tutorial-kubernetes --name=&#34;JobRunr K8s Tutorial&#34; --set-as-default
~$ gcloud beta billing accounts list
~$ gcloud beta billing projects link jobrunr-tutorial-kubernetes --billing-account ${accountId}
~$ gcloud services enable container.googleapis.com
~$ gcloud services enable sqladmin.googleapis.com
~$ docker push gcr.io/jobrunr-tutorial-kubernetes/jobrunr-example-paycheck:1.0
</code></pre><figcaption>The first command creates the GCP project and makes it the default project. The second command will list an account id, account name and some other data. Use the account id in the fourth command to link billing to your GCP project. Next, some Google API's need to enabled. The last command uploads the Docker image to a private Docker registry at Google</figcaption>
</figure>
<p>We also need a Terraform service account with the necessary rights to create the Kubernetes cluster in the GCP project.</p>
<figure style="width: 100%; max-width: 100%">
<pre tabindex="0"><code>~$ gcloud iam service-accounts create terraform --display-name &#34;Terraform admin account&#34;
~$ gcloud projects add-iam-policy-binding jobrunr-tutorial-kubernetes --member=&#39;serviceAccount:terraform@jobrunr-tutorial-kubernetes.iam.gserviceaccount.com&#39; --role=&#39;roles/editor&#39;
~$ gcloud projects add-iam-policy-binding jobrunr-tutorial-kubernetes --member=&#39;serviceAccount:terraform@jobrunr-tutorial-kubernetes.iam.gserviceaccount.com&#39; --role=&#39;roles/resourcemanager.projectIamAdmin&#39;
~$ gcloud projects add-iam-policy-binding jobrunr-tutorial-kubernetes --member=&#39;serviceAccount:terraform@jobrunr-tutorial-kubernetes.iam.gserviceaccount.com&#39; --role=&#39;roles/cloudsql.client&#39;
~$ gcloud iam service-accounts keys create ~/.config/gcloud/jobrunr-tutorial-kubernetes-terraform-admin.json --iam-account=terraform@jobrunr-tutorial-kubernetes.iam.gserviceaccount.com
~$ export TF_CREDS=~/.config/gcloud/jobrunr-tutorial-kubernetes-terraform-admin.json
~$ export GOOGLE_APPLICATION_CREDENTIALS=${TF_CREDS}
</code></pre><figcaption>First, a service account for Terraform is created. It is given the roles editor, resourcemanager.projectIamAdmin and cloudsql.client. Finally, a private key is created which is saved to a json file and exported so that it can be used by Terraform.</figcaption>
</figure>
<h3 id="terraform-deep-dive">Terraform deep dive</h3>
<p>Now we&rsquo;re all setup, we can start defining our infrastructure as code using Terraform.</p>
<p>In Terraform, several concepts exists:</p>
<ul>
<li><strong>providers</strong>: a provider is responsible for understanding API interactions and exposing resources. Providers generally are an IaaS (e.g. AWS, GCP, Microsoft Azure, OpenStack), PaaS (e.g. Heroku), or SaaS services</li>
<li><strong>resources</strong>: resources are the most important element in the Terraform language. Each resource block describes one or more infrastructure objects, such as virtual networks, compute instances, &hellip; .</li>
<li><strong>variables</strong>: a variable can have a default value. if you omit the default value, Terraform will ask you to provide it when running a terraform command.</li>
<li><strong>modules</strong>: a module is nothing more than a folder which combines related terraform files.</li>
<li><strong>outputs</strong>: sometimes a variable is needed which is only known after terraform has done a change on a cloud provider - think of ip-addresses that are given to your application. An output takes that value and exposes it to your variables.</li>
<li>&hellip;</li>
</ul>
<p>In Terraform, you can organize your code the anyway you like it - Terraform itself figures out how to deploy it. In this tutorial, we will use two modules:</p>
<ul>
<li><strong>gke module</strong>: this module is responsible for setting up a Kubernetes Cluster and a Postgres CloudSql instance.</li>
<li><strong>k8s module</strong>: this module will deploy our application to the Kubernetes Cluster and expose it to the internet via a service.</li>
</ul>
<p>Our entrypoint in Terraform is the <code>main.tf</code> configuration file. Next to it, are two directories: <code>gke</code> and <code>k8s</code>. The final directory layout is as follows:</p>
<ul>
<li>gke
<ul>
<li>variables.tf</li>
<li>gcp.tf</li>
<li>cluster.tf</li>
<li>cloudsql.tf</li>
</ul>
</li>
<li>k8s
<ul>
<li>variables.tf</li>
<li>k8s.tf</li>
<li>deployments.tf</li>
<li>services.tf</li>
</ul>
</li>
<li>main.tf</li>
</ul>
<h4 id="entrypoint-for-terraform---maintf">Entrypoint for Terraform - main.tf</h4>
<p><code>main.tf</code> is the entrypoint in our infrastructure as code.</p>
<figure style="width: 100%; max-width: 100%">
<pre tabindex="0"><code>#####################################################################
# Variables
#####################################################################
variable &#34;project&#34; {
  default = &#34;jobrunr-tutorial-kubernetes&#34;
}
variable &#34;region&#34; {
  default = &#34;europe-west1&#34;
}
variable &#34;username&#34; {
  default = &#34;admin&#34;
}
variable &#34;password&#34; {
  default = &#34;cluster-password-change-me&#34;
}

#####################################################################
# Modules
#####################################################################
module &#34;gke&#34; {
  source = &#34;./gke&#34;
  project = var.project
  region = var.region
  username = var.username
  password = var.password
}

module &#34;k8s&#34; {
  source = &#34;./k8s&#34;
  host = module.gke.host
  username = var.username
  password = var.password

  client_certificate = module.gke.client_certificate
  client_key = module.gke.client_key
  cluster_ca_certificate = module.gke.cluster_ca_certificate
  cloudsql_instance = module.gke.cloudsql_db_instance
  cloudsql_db_name = module.gke.cloudsql_db_name
  cloudsql_db_user = module.gke.cloudsql_db_user
  cloudsql_db_password = module.gke.cloudsql_db_password
}
</code></pre><figcaption><strong>main.tf</strong>: in this file the GCP project that was created earlier on is reused. Other variables are also defined - like the region where the application will run and a username and password for the Kubernetes cluster. Next, two modules are defined which consume the variables. The k8s module reuses outputs from the gke module.</figcaption>
</figure>
<h4 id="gke-module">GKE module</h4>
<p>Our GKE module will create a container cluster on Google Cloud and provision a Postgres Cloud Sql instance. We start by defining some variables that can then be used in the other Terraform files.</p>
<figure style="width: 100%; max-width: 100%">
<pre tabindex="0"><code>#####################################################################
# GKE Variables
#####################################################################
variable &#34;project&#34; {}
variable &#34;region&#34; {}
variable &#34;username&#34; {}
variable &#34;password&#34; {}
gke/variables.tf: this file defines all the variables that are needed for the Kubernetes engine in Google Cloud. The values for the variables itself are provided in the main.tf file.
#####################################################################
# GKE Provider
#####################################################################
provider &#34;google&#34; {
  project = var.project
  region  = var.region
}
</code></pre><figcaption><strong>gke/gcp.tf</strong>: the google provider allows to create a container cluster and a Postgres Cloud Sql instance</figcaption>
</figure>
<figure style="width: 100%; max-width: 100%">
<pre tabindex="0"><code>#####################################################################
# GKE Cluster
#####################################################################
resource &#34;google_container_cluster&#34; &#34;jobrunr-tutorial-kubernetes&#34; {
  name               = &#34;jobrunr-tutorial-kubernetes&#34;
  location           = var.region
  initial_node_count = 1

  master_auth {
    username = var.username
    password = var.password
  }

  node_config {
    machine_type = &#34;n1-standard-2&#34;
    oauth_scopes = [
      &#34;https://www.googleapis.com/auth/devstorage.read_only&#34;,
      &#34;https://www.googleapis.com/auth/logging.write&#34;,
      &#34;https://www.googleapis.com/auth/monitoring&#34;,
      &#34;https://www.googleapis.com/auth/service.management.readonly&#34;,
      &#34;https://www.googleapis.com/auth/servicecontrol&#34;,
      &#34;https://www.googleapis.com/auth/trace.append&#34;,
      &#34;https://www.googleapis.com/auth/compute&#34;,
      &#34;https://www.googleapis.com/auth/cloud-platform&#34;, //needed for sqlservice
      &#34;https://www.googleapis.com/auth/sqlservice.admin&#34;
    ]
  }
}


#####################################################################
# Output for K8S
#####################################################################
output &#34;client_certificate&#34; {
  value     = google_container_cluster.jobrunr-tutorial-kubernetes.master_auth[0].client_certificate
  sensitive = true
}

output &#34;client_key&#34; {
  value     = google_container_cluster.jobrunr-tutorial-kubernetes.master_auth[0].client_key
  sensitive = true
}

output &#34;cluster_ca_certificate&#34; {
  value     = google_container_cluster.jobrunr-tutorial-kubernetes.master_auth[0].cluster_ca_certificate
  sensitive = true
}

output &#34;host&#34; {
  value     = google_container_cluster.jobrunr-tutorial-kubernetes.endpoint
  sensitive = true
}
</code></pre><figcaption><strong>gke/cluster.tf</strong>: for the GKE cluster, a machine of type n1-standard-2 is defined, equaling to 2 virtual CPU's. Various oauth_scopes are given - the important ones are compute, cloud-platform and sqlservice.admin. They are needed to interact with the compute engine for our Kubernetes Cluster and with the Postgres Cloud Sql instance. Some outputs are defined which will be consumed by the Terraform Kubernetes resource.</figcaption>
</figure>
<figure style="width: 100%; max-width: 100%">
<pre tabindex="0"><code>#####################################################################
# GKE Cloud SQL
#####################################################################
resource &#34;google_sql_database_instance&#34; &#34;postgres&#34; {
  database_version = &#34;POSTGRES_11&#34;

  settings {
    tier = &#34;db-g1-small&#34;
    database_flags {
      name = &#34;max_connections&#34;
      value = 100
    }
  }
  timeouts {
    delete = &#34;10m&#34;
  }
}

resource &#34;google_sql_user&#34; &#34;users&#34; {
  name = &#34;jobrunr&#34;
  instance = google_sql_database_instance.postgres.name
  password = &#34;changeme&#34;
}

resource &#34;google_sql_database&#34; &#34;database&#34; {
  name = &#34;jobrunr&#34;
  instance = google_sql_database_instance.postgres.name
}

#####################################################################
# Output for K8S
#####################################################################
output &#34;cloudsql_db_name&#34; {
  value = google_sql_database.database.name
  sensitive = true
}

output &#34;cloudsql_db_user&#34; {
  value = google_sql_user.users.name
  sensitive = true
}

output &#34;cloudsql_db_password&#34; {
  value = google_sql_user.users.password
  sensitive = true
}

output &#34;cloudsql_db_instance&#34; {
  value = &#34;${var.project}:${var.region}:${google_sql_database_instance.postgres.name}&#34;
  sensitive = true
}
</code></pre><figcaption><strong>gke/cloudsql.tf</strong>: a Postgres Cloud Sql instance is defined together with a user and a database. Again various outputs are defined which will be consumed by our k8s module.</figcaption>
</figure>
<h4 id="k8s-module">k8s Module</h4>
<p>The k8s module will deploy our docker image we created earlier on and provide it with the environment variables to connect to the Postgres Cloud Sql instance. It will also create a Kubernetes service to expose the application via an Ingress load-balancer to the internet.</p>
<p>We again start with the variables that can be used in the other Terraform files from the k8s module.</p>
<figure style="width: 100%; max-width: 100%">
<pre tabindex="0"><code>#####################################################################
# K8S Variables
#####################################################################
variable &#34;username&#34; {}
variable &#34;password&#34; {}
variable &#34;host&#34; {}
variable client_certificate {}
variable client_key {}
variable cluster_ca_certificate {}

variable cloudsql_instance {}
variable cloudsql_db_name {}
variable cloudsql_db_user {}
variable cloudsql_db_password {}
</code></pre><figcaption><strong>k8s/variables.tf</strong>: the values for these variables are all passed from the main.tf file which acts as a bridge between the gke module and k8s module.</figcaption>
</figure>
<figure style="width: 100%; max-width: 100%">
<pre tabindex="0"><code>#####################################################################
# K8S Provider
#####################################################################
provider &#34;kubernetes&#34; {
  host     = var.host
  username = var.username
  password = var.password

  client_certificate     = base64decode(var.client_certificate)
  client_key             = base64decode(var.client_key)
  cluster_ca_certificate = base64decode(var.cluster_ca_certificate)
}
</code></pre><figcaption>__k8s/k8s.tf__: the kubernetes provider allows us to interact with resources supported by Kubernetes. </figcaption>
</figure>
<figure style="width: 100%; max-width: 100%">
<pre tabindex="0"><code>#####################################################################
# K8S Deployment
#####################################################################
resource &#34;kubernetes_deployment&#34; &#34;jobrunr-tutorial&#34; {
  metadata {
    name = &#34;jobrunr&#34;

    labels = {
      app = &#34;jobrunr&#34;
    }
  }

  spec {
    replicas = 1

    selector {
      match_labels = {
        app = &#34;jobrunr&#34;
      }
    }

    template {
      metadata {
        labels = {
          app = &#34;jobrunr&#34;
        }
      }

      spec {

        container {
          image = &#34;gcr.io/jobrunr-tutorial-kubernetes/jobrunr-example-paycheck:1.0&#34;
          name = &#34;jobrunr&#34;

          port {
            container_port = 8000
          }
          port {
            container_port = 8080
          }

          env {
            name = &#34;CLOUD_SQL_INSTANCE&#34;
            value = var.cloudsql_instance
          }

          env {
            name = &#34;DB_NAME&#34;
            value = var.cloudsql_db_name
          }

          env {
            name = &#34;DB_USER&#34;
            value = var.cloudsql_db_user
          }

          env {
            name = &#34;DB_PASS&#34;
            value = var.cloudsql_db_password
          }

          resources {
            limits {
              cpu = &#34;0.5&#34;
              memory = &#34;1024Mi&#34;
            }
            requests {
              cpu = &#34;250m&#34;
              memory = &#34;512Mi&#34;
            }
          }
        }
      }
    }
  }
}
</code></pre><figcaption><strong>k8s/deployment.tf</strong>: this is the deployment resource where our docker image is provisioned on the Kubernetes cluster. Currently, only 1 replica or instance is requested. The important part is everything under the container attribute - it contains the docker image which the pod should run, the ports that should be exposed and passes all the database credentials using environment variables. On top of that, resource limits and resource requests are defined.</figcaption>
</figure>
<figure style="width: 100%; max-width: 100%">
<pre tabindex="0"><code>#####################################################################
# K8S Service
#####################################################################
resource &#34;kubernetes_service&#34; &#34;jobrunr-tutorial&#34; {
  metadata {
    name = &#34;jobrunr-tutorial&#34;
  }
  spec {
    selector = {
      app = kubernetes_deployment.jobrunr-tutorial.spec.0.template.0.metadata[0].labels.app
    }
    port {
      name = &#34;dashboard&#34;
      port = 8000
      target_port = 8000
    }
    port {
      name = &#34;rest-api&#34;
      port = 8080
      target_port = 8080
    }

    type = &#34;LoadBalancer&#34;
  }
}
</code></pre><figcaption><strong>k8s/service.tf</strong>: the final piece of the puzzle - the Kubernetes Service makes sure that both the Dashboard and the Rest API are available on the internet</figcaption>
</figure>
<h3 id="deploy-time">Deploy time!</h3>
<p>We now can use Terraform commands to provision our application to the Google Cloud Platform. Make sure you are in the directory which contains the main.tf file and the gke and k8s folders when issuing the following commands:</p>
<figure style="width: 100%; max-width: 100%">
<pre tabindex="0"><code>~/jobrunr/gcloud$ terraform init
~/jobrunr/gcloud$ terraform plan
~/jobrunr/gcloud$ terraform apply
</code></pre><figcaption>The terraform init command downloads the necessary plugins (google and kubernetes) to execute the requested infrastructure changes. The second command, terraform plan lists all the required infrastructure changes. The last command, terraform apply makes the actual infrastructure changes.</figcaption>
</figure>
<p>After you run the terraform apply command you have to wait&hellip; typical deploy time is about 5 minutes.</p>
<p>After the deployment succeeds, we can query kubernetes to find out the public ip-address.</p>
<figure style="width: 100%; max-width: 100%">
<pre tabindex="0"><code>~/jobrunr/gcloud$ gcloud container clusters get-credentials jobrunr-tutorial-kubernetes --region europe-west1
~/jobrunr/gcloud$ kubectl get services
~/jobrunr/gcloud$ kubectl get pods
</code></pre><figcaption>The first command downloads credentials and makes them available to the kubectl command. kubectl allows to list all the services and their public ip-addresses. The last command kubectl get pods lists the pods - there should be one pod active.</figcaption>
</figure>
<h3 id="testing-time">Testing time!</h3>
<p>Since the salary slip microservice is now available on the internet, we can test it. First, we will create 10.000 employees in our database. To do so, fire up your favorite browser and go to the url http://${public-ip-from-the-service}:8080/create-employees?amount=10000. This takes about 15 seconds.</p>
<p>Now, visit the JobRunr dashboard - you can find it at http://${public-ip-from-the-service}:8000/dashboard. Navigate to the Recurring jobs tab and trigger the &lsquo;Generate and send salary slip to all employees&rsquo; job. After about 15 seconds, you should have 10.000 enqueued jobs.</p>
<figure>
<img src="/blog/2020-05-06-kubernetes-5-1.webp" alt="" class="kg-image" />
<figcaption>It takes <i>11.229 seconds</i> or about 3 hours and 7 minutes to create all the salary slips.</figcaption>
</figure>
<h3 id="scale-it-up">Scale it up!</h3>
<p>Now, let&rsquo;s add 10 instances of our application to the cluster by changing the replica attribute in the <code>deployment.tf</code> file.</p>
<figure style="width: 100%; max-width: 100%">
<pre tabindex="0"><code>#####################################################################
# K8S Deployment
#####################################################################
resource &#34;kubernetes_deployment&#34; &#34;jobrunr-tutorial&#34; {
  metadata {
    ...
  }

  spec {
    replicas = 10
	...
  }
}
</code></pre><figcaption><strong>k8s/deployment.tf</strong>: the replica value is changed from 1 to 10 in the Kubernetes deployment resource</figcaption>
</figure>
<p>We now apply this change again using the Terraform apply command:
<code>~/jobrunr/gcloud$ terraform apply</code></p>
<p>If you run the command <code>~/jobrunr/gcloud$ kubectl get pods</code> you will now see 10 pods running our JobRunr application. Let&rsquo;s trigger the &lsquo;Generate and send salary slip to all employees&rsquo; recurring job again and wait for it to finish.</p>
<figure>
<img src="/blog/2020-05-06-kubernetes-6.webp" alt="" class="kg-image" />
<figcaption>It only took <i>1.292 seconds</i> or 21 minutes and 30 seconds!</figcaption>
</figure>
<blockquote>
<p>To keep your free credit for GCP, do not forget to issue the command terraform destroy. It will stop all pods, remove the Kubernetes cluster and delete the Postgres Cloud Sql instance.</p>
</blockquote>
<h2 id="conclusion">Conclusion</h2>
<p>JobRunr can easily scale horizontally and allows to distribute all long-running background jobs over multiple instances without any change to the Java code. In an ideal world, we would have seen a 900% speed increase instead of the 869% we see now as we added 9 extra pods. As JobRunr only performs each job only once, there is some overhead when pulling jobs from the queue explaining the difference.</p>
<h2 id="learn-more">Learn more</h2>
<p>I hope you enjoyed this tutorial and you can see the benefits of JobRunr, Terraform and Kubernetes - it allows to easily scale horizontally and distribute all long-running background jobs over multiple instances without any change to the Java code.</p>
<p>To learn more, check out these guides:</p>
<ul>
<li>JobRunr - Java batch processing made easy&hellip;</li>
<li>Terraform - Provision servers in the cloud with Terraform</li>
<li>Kubernetes - Getting started with Kubernetes</li>
<li>Jib - Create fast and easy docker images with Jib</li>
</ul>
<p>If you liked this tutorial, feel free to <a href="https://github.com/jobrunr/jobrunr/stargazers">star us on GitHub</a>!</p>

                </div>
            </section>

        </article>

    </div>
</main>


        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright" style="align-self: start;">
                  &copy; <a href="https://www.jobrunr.io/">JobRunr</a>
                </section>
                <section class="love" style="align-self: start; opacity: 0.7;">
                  Made with <strong style="color: red; font-size: large;">&hearts;</strong> in Belgium
                </section>
                <nav class="site-footer-nav">
                  <div>
                    <div><a href="/en/about/" rel="noopener" style="opacity: 0.5;">JobRunr by Rosoco BV (BE 0807596165)</a></div>
                    <div><a href="/en/licensing/info/" rel="noopener" style="opacity: 0.5;">Terms of use</a></div>
                    <div><a href="/en/privacy/" rel="noopener" style="opacity: 0.5;">Privacy</a></div>
                  </div>
                </nav>
            </div>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/prism.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/components/prism-java.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" defer></script>
    <script src='https://www.jobrunr.io/js/codetabs.js'></script>
    <script src='https://www.jobrunr.io/js/framework.js'></script>
<script>
window.addEventListener("load", (event) => {
  setTimeout(() => {
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#000"
        },
        "button": {
          "background": "transparent",
          "border": "#fff",
          "text": "#fff"
        }
      },
      "content": {
        "link": "Learn more about cookies"
      }
    });
  }, 5000);
});

var links = document.querySelectorAll('a');
for (var i = 0; i < links.length; i++) {
  if (links[i].hostname != window.location.hostname) {
    links[i].target = '_blank';
    links[i].rel = 'noopener';
  }
}
</script>




<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MX5H2KM');</script>



<script type="text/javascript">
  (function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
      t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
      y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
  })(window, document, "clarity", "script", "gndsmglzod");
</script>
</body>
</html>